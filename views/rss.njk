{% extends "layouts/rss.njk" %}

{% block rss %}
  {% if not configError %}
    {# Sync Status & Actions #}
    {% call section({ title: __("rss.syncStatus") }) %}
      <div class="rss-sync-bar">
        <div class="rss-sync-info">
          <span class="rss-sync-label">{{ __("rss.lastSynced") }}</span>
          <span class="rss-sync-time">
            {% if syncState.syncing %}
              <span class="rss-syncing">
                <span class="rss-spinner"></span>
                {{ __("rss.syncing") }}
              </span>
            {% elif syncState.lastSync %}
              {{ syncState.lastSync | date("PPpp") }}
            {% else %}
              {{ __("rss.never") }}
            {% endif %}
          </span>
          {% if syncState.lastError %}
          <span class="rss-feed-error">{{ syncState.lastError }}</span>
          {% endif %}
        </div>
        <div class="button-group" style="display: flex; gap: 0.5rem;">
          <form action="{{ mountPath }}/sync" method="post" style="display: inline;">
            {{ button({
              type: "submit",
              text: __("rss.syncNow"),
              disabled: syncState.syncing
            }) }}
          </form>
          <form action="{{ mountPath }}/clear-resync" method="post" style="display: inline;" id="clear-resync-form">
            {{ button({
              classes: "button--secondary",
              type: "submit",
              text: __("rss.clearResync"),
              disabled: syncState.syncing
            }) }}
          </form>
        </div>
      </div>
    {% endcall %}

    {# Stats #}
    {% call section({ title: __("rss.status") }) %}
      <div class="rss-stats">
        <div class="rss-stat">
          <span class="rss-stat__value">{{ totalFeeds }}</span>
          <span class="rss-stat__label">{{ __("rss.feedsCount") }}</span>
        </div>
        <div class="rss-stat">
          <span class="rss-stat__value">{{ totalItems }}</span>
          <span class="rss-stat__label">{{ __("rss.itemsCount") }}</span>
        </div>
        <div class="rss-stat">
          <span class="rss-stat__value">{{ feeds | selectattr("enabled") | list | length }}</span>
          <span class="rss-stat__label">{{ __("rss.enabled") }}</span>
        </div>
      </div>
    {% endcall %}

    {# Add Feed Form #}
    {% call section({ title: __("rss.addFeed") }) %}
      <form class="rss-add-form" action="{{ mountPath }}/api/feeds" method="post" id="add-feed-form">
        <input
          type="url"
          name="url"
          placeholder="{{ __("rss.feedUrlPlaceholder") }}"
          required
        >
        {{ button({
          type: "submit",
          text: __("rss.addFeed")
        }) }}
      </form>
    {% endcall %}

    {# Feeds List #}
    {% if feeds and feeds.length > 0 %}
    {% call section({ title: __("rss.feeds") }) %}
      <ul class="rss-feed-list">
        {% for feed in feeds %}
        <li class="rss-feed-item" data-feed-id="{{ feed.id }}">
          {% if feed.imageUrl %}
          <img src="{{ feed.imageUrl }}" alt="" class="rss-feed-icon" loading="lazy">
          {% else %}
          <div class="rss-feed-icon-placeholder">&#128240;</div>
          {% endif %}
          <div class="rss-feed-info">
            <div class="rss-feed-title">{{ feed.title }}</div>
            <div class="rss-feed-meta">
              <span>{{ feed.itemCount }} {{ __("rss.itemCount") }}</span>
              {% if feed.lastFetchedAt %}
              <span>&bull; {{ feed.lastFetchedAt | date("PP") }}</span>
              {% endif %}
            </div>
            {% if feed.lastError %}
            <div class="rss-feed-error">{{ feed.lastError }}</div>
            {% endif %}
          </div>
          <div class="rss-feed-actions">
            <label class="rss-toggle">
              <input
                type="checkbox"
                {{ "checked" if feed.enabled }}
                data-toggle-feed="{{ feed.id }}"
              >
              <span class="rss-toggle-slider"></span>
            </label>
            <button
              type="button"
              class="rss-delete-btn"
              data-delete-feed="{{ feed.id }}"
              title="{{ __("rss.removeFeed") }}"
            >&#128465;</button>
          </div>
        </li>
        {% endfor %}
      </ul>
    {% endcall %}
    {% endif %}

    {# Recent Items #}
    {% if recentItems and recentItems.length > 0 %}
    {% call section({ title: __("rss.recentItems") }) %}
      <ul class="rss-item-list">
        {% for item in recentItems %}
        <li class="rss-item">
          {% if item.imageUrl %}
          <img src="{{ item.imageUrl }}" alt="" class="rss-item-image" loading="lazy">
          {% else %}
          <div class="rss-item-placeholder"></div>
          {% endif %}
          <div class="rss-item-info">
            <a href="{{ item.link }}" class="rss-item-title" target="_blank" rel="noopener">
              {{ item.title }}
            </a>
            {% if item.description %}
            <p class="rss-item-description">{{ item.description }}</p>
            {% endif %}
            <div class="rss-item-meta">
              <span>{{ item.feedTitle }}</span>
              {% if item.pubDate %}
              <span>&bull; {{ item.pubDate | date("PP") }}</span>
              {% endif %}
            </div>
          </div>
        </li>
        {% endfor %}
      </ul>
    {% endcall %}
    {% endif %}

    {# Public Page Link #}
    {% call section({ title: __("rss.widget.title") if __("rss.widget.title") else "Public page" }) %}
      <div class="rss-public-link">
        <p>{{ __("rss.widget.description") }}</p>
        {{ button({
          classes: "button--secondary",
          href: "/news/",
          text: __("rss.widget.view"),
          target: "_blank"
        }) }}
      </div>
    {% endcall %}
  {% endif %}

<script>
  // Handle add feed form
  document.getElementById('add-feed-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const url = form.url.value;

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });

      const data = await response.json();
      if (response.ok) {
        location.reload();
      } else {
        alert(data.error || 'Failed to add feed');
      }
    } catch (err) {
      alert('Failed to add feed: ' + err.message);
    }
  });

  // Handle toggle feed
  document.querySelectorAll('[data-toggle-feed]').forEach(input => {
    input.addEventListener('change', async (e) => {
      const feedId = e.target.dataset.toggleFeed;
      const enabled = e.target.checked;

      try {
        const response = await fetch(`{{ mountPath }}/api/feeds/${feedId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });

        if (!response.ok) {
          e.target.checked = !enabled;
          const data = await response.json();
          alert(data.error || 'Failed to update feed');
        }
      } catch (err) {
        e.target.checked = !enabled;
        alert('Failed to update feed: ' + err.message);
      }
    });
  });

  // Handle clear & re-sync
  document.getElementById('clear-resync-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!confirm('This will delete all cached items and re-fetch them from feeds. Continue?')) return;

    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn?.textContent;
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Clearing...';
    }

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await response.json();
      if (response.ok) {
        alert(`Cleared ${data.itemsCleared} items, re-fetched ${data.itemsAdded} items from ${data.feedsProcessed} feeds.`);
        location.reload();
      } else {
        alert(data.error || 'Failed to clear & re-sync');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    } catch (err) {
      alert('Failed to clear & re-sync: ' + err.message);
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
  });

  // Handle delete feed
  document.querySelectorAll('[data-delete-feed]').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const feedId = e.target.dataset.deleteFeed;

      if (!confirm('Are you sure you want to remove this feed?')) return;

      try {
        const response = await fetch(`{{ mountPath }}/api/feeds/${feedId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          location.reload();
        } else {
          const data = await response.json();
          alert(data.error || 'Failed to remove feed');
        }
      } catch (err) {
        alert('Failed to remove feed: ' + err.message);
      }
    });
  });
</script>
{% endblock %}
