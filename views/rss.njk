{% extends "document.njk" %}

{% block content %}
  <style>
    .rss-section { margin-bottom: 2rem; }
    .rss-section h2 { margin-bottom: 1rem; }

    /* Stats grid */
    .rss-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .rss-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      background: var(--color-offset, #f5f5f5);
      border-radius: 0.5rem;
      text-align: center;
    }
    .rss-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-accent, #ff6600);
    }
    .rss-stat-label {
      font-size: 0.75rem;
      color: var(--color-text-secondary, #666);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Sync status */
    .rss-sync-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--color-offset, #f5f5f5);
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .rss-sync-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .rss-sync-label {
      font-size: 0.75rem;
      color: var(--color-text-secondary, #666);
      text-transform: uppercase;
    }
    .rss-sync-time {
      font-weight: 500;
    }
    .rss-syncing {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--color-accent, #ff6600);
    }
    .rss-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: rss-spin 0.8s linear infinite;
    }
    @keyframes rss-spin {
      to { transform: rotate(360deg); }
    }

    /* Add feed form */
    .rss-add-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .rss-add-form input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--color-border, #ddd);
      border-radius: 0.25rem;
      font-size: 0.875rem;
    }
    .rss-add-form input:focus {
      outline: none;
      border-color: var(--color-accent, #ff6600);
    }

    /* Feed list */
    .rss-feed-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .rss-feed-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--color-border, #eee);
    }
    .rss-feed-item:last-child { border-bottom: none; }
    .rss-feed-icon {
      width: 32px;
      height: 32px;
      object-fit: cover;
      border-radius: 0.25rem;
      flex-shrink: 0;
    }
    .rss-feed-icon-placeholder {
      width: 32px;
      height: 32px;
      background: var(--color-border, #ddd);
      border-radius: 0.25rem;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-secondary, #666);
      font-size: 1rem;
    }
    .rss-feed-info {
      flex: 1;
      min-width: 0;
    }
    .rss-feed-title {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rss-feed-meta {
      display: flex;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--color-text-secondary, #666);
    }
    .rss-feed-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .rss-feed-error {
      color: #d32f2f;
      font-size: 0.75rem;
    }

    /* Item list */
    .rss-item-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .rss-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--color-border, #eee);
    }
    .rss-item:last-child { border-bottom: none; }
    .rss-item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 0.25rem;
      flex-shrink: 0;
    }
    .rss-item-placeholder {
      width: 60px;
      height: 60px;
      background: var(--color-border, #ddd);
      border-radius: 0.25rem;
      flex-shrink: 0;
    }
    .rss-item-info {
      flex: 1;
      min-width: 0;
    }
    .rss-item-title {
      font-weight: 500;
      text-decoration: none;
      color: inherit;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rss-item-title:hover { text-decoration: underline; }
    .rss-item-description {
      font-size: 0.875rem;
      color: var(--color-text-secondary, #666);
      margin: 0.25rem 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .rss-item-meta {
      font-size: 0.75rem;
      color: var(--color-text-secondary, #666);
    }

    /* Toggle switch */
    .rss-toggle {
      position: relative;
      width: 40px;
      height: 22px;
      cursor: pointer;
    }
    .rss-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .rss-toggle-slider {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      border-radius: 22px;
      transition: 0.3s;
    }
    .rss-toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
    }
    .rss-toggle input:checked + .rss-toggle-slider {
      background-color: var(--color-accent, #ff6600);
    }
    .rss-toggle input:checked + .rss-toggle-slider:before {
      transform: translateX(18px);
    }

    /* Delete button */
    .rss-delete-btn {
      background: none;
      border: none;
      color: #d32f2f;
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1rem;
      opacity: 0.6;
    }
    .rss-delete-btn:hover {
      opacity: 1;
    }
  </style>

  {% if error %}
    {{ prose({ text: error.message }) }}
  {% else %}
    {# Sync Status #}
    <div class="rss-sync-status">
      <div class="rss-sync-info">
        <span class="rss-sync-label">{{ __("rss.lastSynced") }}</span>
        <span class="rss-sync-time">
          {% if syncState.syncing %}
            <span class="rss-syncing">
              <span class="rss-spinner"></span>
              {{ __("rss.syncing") }}
            </span>
          {% elif syncState.lastSync %}
            {{ syncState.lastSync | date("PPpp") }}
          {% else %}
            {{ __("rss.never") }}
          {% endif %}
        </span>
        {% if syncState.lastError %}
        <span class="rss-feed-error">{{ syncState.lastError }}</span>
        {% endif %}
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <form action="{{ publicUrl }}/sync" method="post" style="margin: 0;">
          {{ button({
            type: "submit",
            text: __("rss.syncNow"),
            disabled: syncState.syncing
          }) }}
        </form>
        <form action="{{ publicUrl }}/clear-resync" method="post" style="margin: 0;" id="clear-resync-form">
          {{ button({
            type: "submit",
            text: __("rss.clearResync"),
            disabled: syncState.syncing
          }) }}
        </form>
      </div>
    </div>

    {# Stats #}
    <section class="rss-section">
      <div class="rss-stats-grid">
        <div class="rss-stat">
          <span class="rss-stat-value">{{ totalFeeds }}</span>
          <span class="rss-stat-label">{{ __("rss.feedsCount") }}</span>
        </div>
        <div class="rss-stat">
          <span class="rss-stat-value">{{ totalItems }}</span>
          <span class="rss-stat-label">{{ __("rss.itemsCount") }}</span>
        </div>
        <div class="rss-stat">
          <span class="rss-stat-value">{{ feeds | selectattr("enabled") | list | length }}</span>
          <span class="rss-stat-label">{{ __("rss.enabled") }}</span>
        </div>
      </div>
    </section>

    {# Add Feed Form #}
    <section class="rss-section">
      <h2>{{ __("rss.addFeed") }}</h2>
      <form class="rss-add-form" action="{{ publicUrl }}/api/feeds" method="post" id="add-feed-form">
        <input
          type="url"
          name="url"
          placeholder="{{ __("rss.feedUrlPlaceholder") }}"
          required
        >
        {{ button({
          type: "submit",
          text: __("rss.addFeed")
        }) }}
      </form>
    </section>

    {# Feeds List #}
    <section class="rss-section">
      <h2>{{ __("rss.feeds") }}</h2>
      {% if feeds and feeds.length > 0 %}
      <ul class="rss-feed-list">
        {% for feed in feeds %}
        <li class="rss-feed-item" data-feed-id="{{ feed.id }}">
          {% if feed.imageUrl %}
          <img src="{{ feed.imageUrl }}" alt="" class="rss-feed-icon" loading="lazy">
          {% else %}
          <div class="rss-feed-icon-placeholder">&#128240;</div>
          {% endif %}
          <div class="rss-feed-info">
            <div class="rss-feed-title">{{ feed.title }}</div>
            <div class="rss-feed-meta">
              <span>{{ feed.itemCount }} {{ __("rss.itemCount") }}</span>
              {% if feed.lastFetchedAt %}
              <span>&bull; {{ feed.lastFetchedAt | date("PP") }}</span>
              {% endif %}
            </div>
            {% if feed.lastError %}
            <div class="rss-feed-error">{{ feed.lastError }}</div>
            {% endif %}
          </div>
          <div class="rss-feed-actions">
            <label class="rss-toggle">
              <input
                type="checkbox"
                {{ "checked" if feed.enabled }}
                data-toggle-feed="{{ feed.id }}"
              >
              <span class="rss-toggle-slider"></span>
            </label>
            <button
              type="button"
              class="rss-delete-btn"
              data-delete-feed="{{ feed.id }}"
              title="{{ __("rss.removeFeed") }}"
            >&#128465;</button>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      {{ prose({ text: __("rss.noFeeds") }) }}
      {% endif %}
    </section>

    {# Recent Items #}
    <section class="rss-section">
      <h2>{{ __("rss.recentItems") }}</h2>
      {% if recentItems and recentItems.length > 0 %}
      <ul class="rss-item-list">
        {% for item in recentItems %}
        <li class="rss-item">
          {% if item.imageUrl %}
          <img src="{{ item.imageUrl }}" alt="" class="rss-item-image" loading="lazy">
          {% else %}
          <div class="rss-item-placeholder"></div>
          {% endif %}
          <div class="rss-item-info">
            <a href="{{ item.link }}" class="rss-item-title" target="_blank" rel="noopener">
              {{ item.title }}
            </a>
            {% if item.description %}
            <p class="rss-item-description">{{ item.description }}</p>
            {% endif %}
            <div class="rss-item-meta">
              <span>{{ item.feedTitle }}</span>
              {% if item.pubDate %}
              <span>&bull; {{ item.pubDate | date("PP") }}</span>
              {% endif %}
            </div>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      {{ prose({ text: __("rss.noItems") }) }}
      {% endif %}
    </section>

    {# Link to public page #}
    <div class="rss-sync-status">
      <p>{{ __("rss.widget.description") }}</p>
      {{ button({
        href: "/news/",
        text: __("rss.widget.view"),
        target: "_blank"
      }) }}
    </div>
  {% endif %}

  <script>
    // Handle add feed form
    document.getElementById('add-feed-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const url = form.url.value;

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await response.json();
        if (response.ok) {
          location.reload();
        } else {
          alert(data.error || 'Failed to add feed');
        }
      } catch (err) {
        alert('Failed to add feed: ' + err.message);
      }
    });

    // Handle toggle feed
    document.querySelectorAll('[data-toggle-feed]').forEach(input => {
      input.addEventListener('change', async (e) => {
        const feedId = e.target.dataset.toggleFeed;
        const enabled = e.target.checked;

        try {
          const response = await fetch(`{{ publicUrl }}/api/feeds/${feedId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled })
          });

          if (!response.ok) {
            e.target.checked = !enabled;
            const data = await response.json();
            alert(data.error || 'Failed to update feed');
          }
        } catch (err) {
          e.target.checked = !enabled;
          alert('Failed to update feed: ' + err.message);
        }
      });
    });

    // Handle clear & re-sync
    document.getElementById('clear-resync-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!confirm('This will delete all cached items and re-fetch them from feeds. Continue?')) return;

      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn?.textContent;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Clearing...';
      }

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        if (response.ok) {
          alert(`Cleared ${data.itemsCleared} items, re-fetched ${data.itemsAdded} items from ${data.feedsProcessed} feeds.`);
          location.reload();
        } else {
          alert(data.error || 'Failed to clear & re-sync');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }
      } catch (err) {
        alert('Failed to clear & re-sync: ' + err.message);
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    });

    // Handle delete feed
    document.querySelectorAll('[data-delete-feed]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const feedId = e.target.dataset.deleteFeed;

        if (!confirm('Are you sure you want to remove this feed?')) return;

        try {
          const response = await fetch(`{{ publicUrl }}/api/feeds/${feedId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            location.reload();
          } else {
            const data = await response.json();
            alert(data.error || 'Failed to remove feed');
          }
        } catch (err) {
          alert('Failed to remove feed: ' + err.message);
        }
      });
    });
  </script>
{% endblock %}
